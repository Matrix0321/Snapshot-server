<!DOCTYPE html>
<html>
<head><meta charset="utf-8"/><title>Snapshot Query</title></head>
<body>
  <h1>Snapshot 查询</h1>
  <form id="f">
    <label>Snapshot 名称: <input id="name" value="bachQuery"></label><br/>
    <label>SPARQL 文件:
      <select id="queryFile">
        <option value="bach_family_all.sparql">bach_family_all.sparql</option>
        <option value="country_language.sparql">country_language.sparql</option>
        <!-- 你把常用的文件名都列进来 -->
      </select>
    </label><br/>
    <label>Domain Sort: <input id="dom" value="Person"></label><br/>
    <label>Range Sort: <input id="rng" value="Person"></label><br/>
    <label>Filter 年份 ≥ <input id="minYear" value="1700" size="4"></label>
    <label>≤ <input id="maxYear" value="1780" size="4"></label><br/>
    <button type="submit">查询并过滤</button>
  </form>
  <pre id="out"></pre>

  <script>
    async function fetchSPARQL(name) {
      // 直接 fetch 你 static 目录里的 SPARQL 文本
      const res = await fetch('/static/'+name);
      return await res.text();
    }
    document.getElementById('f').onsubmit = async e => {
      e.preventDefault();
      const name = document.getElementById('name').value;
      const qfile = document.getElementById('queryFile').value;
      const dom = document.getElementById('dom').value;
      const rng = document.getElementById('rng').value;
      const minY = parseInt(document.getElementById('minYear').value);
      const maxY = parseInt(document.getElementById('maxYear').value);

      // 1. 读 SPARQL
      const query = await fetchSPARQL(qfile);

      // 2. 调 createSnapshot（也可以直接 call GET + 后处理，但此处演示一次全流程）
      const payload = {
        snapshotName: name,
        sortSymbols: [dom, rng],
        relations: [{
          riRelationName: name,
          riVariables: [], // 可留空，让后端再提取
          riQuery: query,
          riDomainSort: dom,
          riRangeSort: rng
        }]
      };
      await fetch('/snapshots', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });

      // 3. 再 GET 原始数据
      const r2 = await fetch('/snapshots/'+encodeURIComponent(name));
      let data = await r2.json();

      // 4. 过滤年份
      data.relations[name] = data.relations[name].filter(item => {
        const d = new Date(item.birthDate||item.foundingDate||'');
        const y = d.getFullYear();
        return y>=minY && y<=maxY;
      });

      // 5. 显示结果
      document.getElementById('out').textContent = JSON.stringify(data, null, 2);
    };
  </script>
</body>
</html>
